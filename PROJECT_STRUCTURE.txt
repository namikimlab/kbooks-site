# Project Structure Overview

This is a Next.js 15 App Router project focused on a social reading/list platform. The high‑level layout:

## Root
- `package.json`, `package-lock.json`, `pnpm-lock.yaml`: dependency manifests; project currently uses npm scripts (`npm run dev`, `npm run lint`).
- `next.config.ts`, `tsconfig.json`, `postcss.config.mjs`, `eslint.config.mjs`: framework/tooling configs.
- `components.json`: shadcn-style component generator metadata.
- `README.md`: default Next.js boilerplate.
- `todo.md` / `kb.txt`: ad-hoc local notes.
- `public/`: static assets (SVG logos, `placeholder-cover.jpg` fallback cover, `avatar-fallback.svg` default profile image).

## src/app (Next.js App Router)
- `layout.tsx`: global layout, wraps all pages.
- `page.tsx`: landing/home page.
- `/books/[id]/page.tsx`: book detail page; fetches book metadata, triggers background enrichment, renders `BookActionButtons`.
- `/lists/new/page.tsx`: client form for creating lists (title/description/visibility) via `/api/user-lists`.
- `/lists/[id]/page.tsx`: server-rendered list detail—title, owner info, orderable book list, edit/share controls. Uses `ListBooksList` for drag/touch reordering via `/api/user-lists/[id]/positions` and now surfaces list-like controls (inline heart indicator + sticky CTA) backed by `user_list_like`.
- `/lists/[id]/edit/page.tsx`: edit UI for title/description/visibility; protected via Supabase auth.
- `/users/[handle]/page.tsx`: profile hub with tabs for activity, likes, reads, lists. Renders summary components from `src/components/users`.
- `/profile/edit/page.tsx`: profile editing form. Strict server-side validation keeps handles lowercase and unique, blocks reserved words, enforces rate limiting, validates nickname/link constraints, and sanitizes avatar uploads (type + ≤1.5 MB). After saving, redirects back to the profile page with a toast flag.
- `/onboarding/page.tsx`: fallback onboarding flow (currently skipped because Kakao/Supabase populate `user_profile` automatically) that can generate default nicknames/avatars.
- `/search/page.tsx`: Kakao-powered search listing. Server component trims `q`, short-circuits when empty, then calls `kakaoSearch` (Redis-cached fetch against Kakao API, 30 results per page, no Supabase reads) to render paginated cards linking to `/books/[isbn13]`.
- `/api/...`: serverless route handlers (Supabase CRUD, external fetch proxies, cover/thumb endpoints, list order updates, etc.). Key routes:
  - `/api/user-lists`: create lists.
  - `/api/user-lists/[id]`: get/update/delete individual lists.
  - `/api/user-lists/[id]/positions`: new endpoint that resets and rewrites `user_list_book.position` for reordering.
- `/api/fetch-*`, `/api/thumbs/[isbn]`, etc.: book data acquisition.

## src/components
Grouped into subfolders:
- `components/lists/`: list-specific client components (`ListBooksList` handles draggable/touch reordering; `ListCoverCollage` shows hero cover).
- `components/users/`: profile sections (likes, reads, lists) with client interactivity (pagination, toggles, Supabase mutations).
- `components/sections/`, `components/ui/`: shared UI atoms built from Radix/shadcn (Buttons, Tabs, etc.).
- Other shared components: `BookActionButtons`, `BookListModal`, `CoverImage`, `DescriptionSection`, etc.

## src/lib
- Supabase helpers (`supabaseServerClients`, `supabaseBrowserClient`), book data helpers (`books.ts`), env utilities, ISBN utilities, Kakao/Kyobo integrations, etc. These modules encapsulate server-side logic invoked by API routes or server components.

## src/utils / src/styles
- Utility helpers (`lib/utils.ts` exports `cn`, etc.) and Tailwind/global CSS definitions.

## Cross-cutting behaviors
- List detail page now includes cover collage, owner controls, draggable/touch order (ListBooksList), list edit route mirrors create page, and `/api/user-lists/[id]/positions` resets+rewrites positions.
- Likes/Reads tabs share icon-based view toggles, privacy filter fills width on mobile, pagination uses 30 items/page, and user interactions show toast feedback.
- Profile edit experience: client form mirrors server constraints (handle length, reserved words, nickname limits, link parsing) and redirects to the public profile with a toast (“프로필이 저장됐어요”) once the server-side upsert succeeds.
- Login flow: `/login` now prioritizes Kakao OAuth (environment-aware redirect) while keeping the email magic-link form hidden for future use. `/auth/callback` exchanges codes via Supabase, then sends new users to `/onboarding` only if they lack a `user_profile`.
- Supabase table names renamed (book_like, book, book_kyobo_raw, user_list, user_list_book, user_read) and MAX_BOOKS_PER_LIST constant governs list cap everywhere.
- Auth: Supabase client on both server (`createSupabaseServerClient`) and client (`createSupabaseBrowserClient`) ensures gated routes (lists/profile edit, reordering) validate ownership.
- Data: Supabase tables `books`, `user_list`, `user_list_book`, `book_like`, `user_read`, etc. Most server components fetch directly via server client.
- UI states: Client components manage optimistic updates/toasts (likes, reads, list creation, reordering) and use Next.js routing (`useRouter`, `router.refresh`) for data refetch.
- Cover delivery: Components request `/api/thumbs/[isbn]`, which streams Supabase Storage covers when present, otherwise proxies Kakao's thumbnail or serves an inline “표지 없음” SVG fallback. `/api/covers/[isbn]` follows the same cascade, so book/detail pages never render broken images.

## Data Flow Details
- **Search (`/search`)**: Server component grabs `q` and `page`, calls `kakaoSearch`. That helper hits Upstash Redis (`search:{q}:{page}:{size}`) first; on cache miss it fetches Kakao’s book search API, normalizes each document, writes it back to Redis (5‑minute TTL), and returns the list. Cover `<Image>` tags always point to `/api/thumbs/{isbn}` rather than Kakao thumbnails directly.
- **Thumbnail lookup (`/api/thumbs/[isbn]`)**: The handler first tries Supabase Storage bucket `book-covers/{isbn}.jpg` and streams it if it exists. Otherwise it performs a one-off Kakao lookup, proxies the remote thumbnail back to the client, and only if both fail does it emit an inline SVG placeholder.
- **Book detail (`/books/[isbn]`)**  
  - *Book metadata process*: Normalize ISBN to 13 digits, read `book` from Supabase, create a stub if it’s missing, and when key fields (title/author/etc.) are blank run `/api/fetch-kakao?isbn=…` to enrich. That API consults Redis (`kakao:book:{isbn}`) before calling Kakao, then upserts the result back into Supabase so the page can re-render with complete data.  
  - *Cover image process*: The detail page renders `<CoverImage isbn13={…}>`, which always resolves through `/api/thumbs/{isbn}`. That route attempts Supabase Storage first, falls back to a live Kakao thumbnail proxy, and finally returns an inline SVG placeholder. No direct Kakao URLs are embedded in the page.  
  - *Category/tag process*: After metadata is ready, the page checks `shouldFetchKyoboCategory`. If categories or `kyobo_fetched_at` are missing/stale, it fire-and-forgets `/api/fetch-kyobo-category?isbn=…`, which scrapes Kyobo, stores raw payloads (`book_kyobo_raw`), and updates `book.category`/`book.kyobo_url`. Render-time tags simply reflect whatever `category` array is stored; while the fetch is in flight the UI shows “태그 수집 중이에요.”

## Design Principles
- **Minimal + Modular:** prefer small, composable components, API handlers, and helpers. Avoid over-engineering—each module should do one job clearly.
- **Straightforward + Safe:** optimize for readability and predictable behavior; include guardrails (auth checks, error handling) so features remain production-ready without unnecessary complexity.

Use this file as a quick orientation map when navigating or extending the codebase. Update it whenever major structural changes land so future work has an up‑to‑date reference.
